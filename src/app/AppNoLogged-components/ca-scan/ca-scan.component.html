<div class="section">
  <div class="card d-inline-block m-auto w-fit-content">
    <div class="card-body">
      <h3 class="card-title fw-bold">Scanner Prodotti</h3>
      <div class="alert sc-primary d-flex align-items-center mt-4" role="alert">
        <i
          class="bx bx-info-circle align-middle me-2"
          style="font-size: 30px"
        ></i>
        <div>
          Scannerizza il Codice a barre del prodotto e aggiungilo al magazzino.
        </div>
      </div>
      <div class="container">
        <!-- For camera -->
        <ngx-scanner-qrcode
          #action="scanner"
          [config]="config"
          (event)="onEvent($event, action)"
        ></ngx-scanner-qrcode>

        <!-- data  -->
        <form #myForm="ngForm" (ngSubmit)="addProduct()">
          <div *ngIf="!isEditing" class="row mt-3">
            <!-- <div *ngIf="productId" class="col-3">
              <p class="data"><strong>Codice:</strong> {{ productId }}</p>
            </div> -->
            <div *ngIf="productId" class="col-3">
              <p class="data"><strong>Codice:</strong> {{ productId }}</p>
            </div>
            <div *ngIf="apiCalled && !productIsPresent" class="col-3">
              <!-- <div class="input-group mb-3"> -->
              <label for="productName" class="fw-bold form-label"
                >Nome prodotto</label
              >
              <input
                type="text"
                id="productName"
                name="productName"
                class="form-control"
                aria-label="Sizing example input"
                aria-describedby="inputGroup-sizing-default"
                [(ngModel)]="productName"
              />
              <!-- </div> -->
            </div>
            <div *ngIf="apiCalled && !productIsPresent" class="col-3">
              <!-- <div class="input-group mb-3"> -->
              <label for="productPrize" class="fw-bold form-label"
                >Prezzo</label
              >
              <input
                type="number"
                id="productPrize"
                name="productPrize"
                class="form-control"
                aria-label="Sizing example input"
                aria-describedby="inputGroup-sizing-default"
                [(ngModel)]="productPrize"
              />
              <!-- </div> -->
            </div>
            <div *ngIf="apiCalled && !productIsPresent" class="col-3">
              <!-- <div class="input-group mb-3"> -->
              <label for="quantity" class="fw-bold form-label">Quantità</label>
              <input
                type="number"
                id="quantity"
                name="quantity"
                class="form-control"
                aria-label="Sizing example input"
                aria-describedby="inputGroup-sizing-default"
                [(ngModel)]="quantity"
              />
              <!-- </div> -->
            </div>
            <div *ngIf="productId && productIsPresent" class="col-9">
              <div
                class="alert sc-primary d-flex align-items-center"
                role="alert"
              >
                <i
                  class="bx bx-info-circle align-middle me-2"
                  style="font-size: 30px"
                ></i>
                <div>
                  Prodotto già registrato nel magazzino, per aggiornare la
                  quantità o modificare altri dati, procedere dall'elenco qui
                  sotto.
                </div>
              </div>
            </div>
          </div>
        </form>

        <!-- <div class="alert alert-primary text-center" role="alert">
          {{ productName }}
        </div>

        <div class="card text-center">
          <div class="card-body">
            <span class="card-text">{{ productName }}</span>
          </div>
        </div> -->

        <!-- Loading -->

        <div
          class="mt-3 text-center d-flex justify-content-center align-items-center"
        >
          <p *ngIf="action.isLoading">⌛ Caricamento in corso...</p>
        </div>

        <!-- start -->
        <div class="text-center mt-3">
          <button
            type="button"
            class="btn"
            [class.btn-dark]="!action.isStart"
            [class.btn-warning]="action.isStart"
            [disabled]="action.isLoading"
            (click)="handle(action, action.isStart ? 'stop' : 'start')"
          >
            <img
              [src]="
                action.isStart
                  ? 'https://id1945.github.io/images/svg/camera-off.svg'
                  : 'https://id1945.github.io/images/svg/camera-on.svg'
              "
              width="30px"
              [class.btn-white]="action.isStart"
              style="filter: brightness(0) invert(1)"
            />
          </button>
        </div>
      </div>
      <div class="mt-5 text-center">
        <button
          type="button"
          class="btn sc-primary"
          [disabled]="isButtonDisabled || !areFieldsFilled()"
          (click)="addProduct()"
        >
          Aggiungi
        </button>
      </div>
      <h3 class="card-title fw-bold mt-3">Magazzino</h3>
      <div class="row mt-3">
        <div class="col-12">
          <table *ngIf="dataSource && dataSource.length > 0" class="table">
            <thead>
              <tr>
                <th>Codice Prodotto</th>
                <th>Nome Prodotto</th>
                <th>Prezzo</th>
                <th>Quantità</th>
                <th></th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of dataSource">
                <td class="align-middle">{{ item.id }}</td>
                <td class="align-middle">{{ item.nomeProdotto }}</td>
                <td class="align-middle">
                  &euro; {{ item.prezzo | number : "1.2-2" }}
                </td>
                <td class="align-middle">{{ item.quantita }} pz</td>
                <!-- (click)="deleteProduct(item.id.toString())" -->
                <td class="align-middle">
                  <button
                    class="btn sc-primary"
                    data-bs-toggle="modal"
                    data-bs-target="#editProductModal"
                    (click)="selectProductForEdit(item.id)"
                  >
                    <i class="bx bxs-edit"></i>
                  </button>
                </td>
                <td class="align-middle">
                  <button
                    data-bs-toggle="modal"
                    data-bs-target="#editProductModal"
                    class="btn sc-primary"
                    (click)="confirmDeleteProduct(item.id.toString())"
                  >
                    <i class="bx bx-trash"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
          <div
            *ngIf="dataSource.length == 0"
            class="alert sc-primary d-flex align-items-center mt-4"
            role="alert"
          >
            <i
              class="bx bx-info-circle align-middle me-2"
              style="font-size: 30px"
            ></i>
            <div>Nessun prodotto presente nel magazzino.</div>
          </div>
          <!-- Modal -->
          <div
            class="modal fade"
            id="editProductModal"
            tabindex="-1"
            aria-labelledby="exampleModalLabel"
            aria-hidden="true"
          >
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header custom-modal-header">
                  <h5 class="modal-title" id="exampleModalLabel">
                    {{
                      confirmDelete
                        ? "Conferma Eliminazione - " + selectedProduct.id
                        : "Modifica Prodotto - " + selectedProduct.id
                    }}
                  </h5>
                  <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                  ></button>
                </div>
                <div class="modal-body">
                  <!-- Contenuto -->
                  <div *ngIf="!confirmDelete">
                    <div class="row mt-3">
                      <div class="col-12">
                        <label for="productName" class="fw-bold form-label"
                          >Nome prodotto</label
                        >
                        <input
                          type="text"
                          id="productName"
                          name="productName"
                          class="form-control"
                          aria-label="Sizing example input"
                          aria-describedby="inputGroup-sizing-default"
                          [(ngModel)]="selectedProduct.nomeProdotto"
                        />
                      </div>
                    </div>
                    <div class="row mt-3">
                      <div class="col-6">
                        <label for="productPrice" class="fw-bold form-label"
                          >Prezzo</label
                        >
                        <input
                          type="number"
                          id="productPrice"
                          name="productPrice"
                          class="form-control"
                          aria-label="Sizing example input"
                          aria-describedby="inputGroup-sizing-default"
                          [(ngModel)]="selectedProduct.prezzo"
                        />
                      </div>
                      <div class="col-6">
                        <label for="quantity" class="fw-bold form-label"
                          >Quantità</label
                        >
                        <input
                          type="number"
                          id="quantity"
                          name="quantity"
                          class="form-control"
                          aria-label="Sizing example input"
                          aria-describedby="inputGroup-sizing-default"
                          [(ngModel)]="selectedProduct.quantita"
                        />
                      </div>
                    </div>
                  </div>
                  <div *ngIf="confirmDelete">
                    Sei sicuro di voler eliminare questo prodotto?
                  </div>
                </div>
                <div class="modal-footer">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                  >
                    Chiudi
                  </button>
                  <button
                    *ngIf="!confirmDelete"
                    type="button"
                    class="btn sc-primary"
                    (click)="updateProduct()"
                  >
                    Salva modifiche
                  </button>
                  <button
                    *ngIf="confirmDelete"
                    type="button"
                    class="btn sc-primary"
                    (click)="deleteProduct(selectedProduct.id.toString())"
                  >
                    Conferma
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
